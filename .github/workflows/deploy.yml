name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: nav-dashboard

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ° Cloudflare
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: æ›´æ–° wrangler.toml é…ç½®
        run: |
          echo "ä½¿ç”¨ Secrets æ›´æ–° wrangler.toml..."
          
          cat > wrangler.toml << EOF
          name = "nav-dashboard"
          main = "src/index.js"
          compatibility_date = "2024-01-01"
          
          # D1 æ•°æ®åº“ç»‘å®š
          [[d1_databases]]
          binding = "DB"
          database_name = "nav-dashboard-db"
          database_id = "${{ secrets.D1_DATABASE_ID }}"
          
          # KV å‘½åç©ºé—´ç»‘å®š
          [[kv_namespaces]]
          binding = "KV"
          id = "${{ secrets.KV_NAMESPACE_ID }}"
          EOF
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°"
          cat wrangler.toml

      - name: åˆå§‹åŒ– D1 æ•°æ®åº“
        run: |
          echo "åˆå§‹åŒ–æ•°æ®åº“..."
          wrangler d1 execute nav-dashboard-db --file=./schema.sql --yes || echo "æ•°æ®åº“å¯èƒ½å·²åˆå§‹åŒ–"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

      - name: éƒ¨ç½² Workers
        id: deploy-workers
        run: |
          echo "éƒ¨ç½² Workers API..."
          OUTPUT=$(wrangler deploy 2>&1)
          echo "$OUTPUT"
          
          # æå– Workers URL
          WORKER_URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]+\.workers\.dev' | head -n 1)
          
          if [ -z "$WORKER_URL" ]; then
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
            WORKER_URL="https://nav-dashboard.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev"
          fi
          
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "âœ… Workers å·²éƒ¨ç½²: $WORKER_URL"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: æ³¨å…¥ API é…ç½®åˆ°å‰ç«¯
        run: |
          echo "æ³¨å…¥ Workers URL åˆ°å‰ç«¯..."
          WORKER_URL="${{ steps.deploy-workers.outputs.worker_url }}"
          
          # åœ¨ index.html æ·»åŠ é…ç½®
          sed -i 's|</head>|<script>window.WORKER_URL = "'"$WORKER_URL"'";</script></head>|' public/index.html
          
          # åœ¨ admin.html æ·»åŠ é…ç½®
          sed -i 's|</head>|<script>window.WORKER_URL = "'"$WORKER_URL"'";</script></head>|' public/admin.html
          
          echo "âœ… API åœ°å€å·²æ³¨å…¥: $WORKER_URL"

      - name: éƒ¨ç½² Pages
        run: |
          echo "éƒ¨ç½² Pages é™æ€æ–‡ä»¶..."
          wrangler pages deploy public --project-name=${{ env.PROJECT_NAME }} --branch=main --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½²æ€»ç»“
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
          echo "  â€¢ Workers API: https://nav-dashboard.ä½ çš„è´¦æˆ·.workers.dev"
          echo "  â€¢ Pages å‰ç«¯: https://${{ env.PROJECT_NAME }}.pages.dev"
          echo ""
          echo "ğŸ“ æ³¨æ„: å‰ç«¯éœ€è¦é…ç½® Workers API åœ°å€"
