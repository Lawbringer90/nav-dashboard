name: Deploy to Cloudflare (å…¨è‡ªåŠ¨)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: nav-dashboard
  D1_DATABASE_NAME: nav-dashboard-db
  KV_NAMESPACE_NAME: nav-images

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: å…¨è‡ªåŠ¨éƒ¨ç½²
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: æ£€æŸ¥å¹¶åˆ›å»º D1 æ•°æ®åº“
        id: check-d1
        run: |
          echo "æ£€æŸ¥ D1 æ•°æ®åº“æ˜¯å¦å­˜åœ¨..."
          
          # å°è¯•åˆ—å‡ºæ•°æ®åº“
          DB_LIST=$(wrangler d1 list --json 2>/dev/null || echo "[]")
          
          # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
          DB_ID=$(echo "$DB_LIST" | jq -r ".[] | select(.name==\"${{ env.D1_DATABASE_NAME }}\") | .uuid" | head -n 1)
          
          if [ -z "$DB_ID" ] || [ "$DB_ID" = "null" ]; then
            echo "æ•°æ®åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            CREATE_OUTPUT=$(wrangler d1 create ${{ env.D1_DATABASE_NAME }} --json)
            DB_ID=$(echo "$CREATE_OUTPUT" | jq -r '.uuid // .database_id // empty')
            echo "âœ… D1 æ•°æ®åº“å·²åˆ›å»º: $DB_ID"
          else
            echo "âœ… D1 æ•°æ®åº“å·²å­˜åœ¨: $DB_ID"
          fi
          
          echo "db_id=$DB_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: åˆå§‹åŒ– D1 æ•°æ®åº“
        run: |
          echo "åˆå§‹åŒ–æ•°æ®åº“..."
          wrangler d1 execute ${{ env.D1_DATABASE_NAME }} --file=./schema.sql --yes || echo "æ•°æ®åº“å¯èƒ½å·²åˆå§‹åŒ–"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: æ£€æŸ¥å¹¶åˆ›å»º KV å‘½åç©ºé—´
        id: check-kv
        run: |
          echo "æ£€æŸ¥ KV å‘½åç©ºé—´æ˜¯å¦å­˜åœ¨..."
          
          # åˆ—å‡º KV å‘½åç©ºé—´
          KV_LIST=$(wrangler kv:namespace list --json 2>/dev/null || echo "[]")
          
          # æŸ¥æ‰¾åŒ¹é…çš„å‘½åç©ºé—´
          KV_ID=$(echo "$KV_LIST" | jq -r ".[] | select(.title | contains(\"${{ env.KV_NAMESPACE_NAME }}\")) | .id" | head -n 1)
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" = "null" ]; then
            echo "KV å‘½åç©ºé—´ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            CREATE_OUTPUT=$(wrangler kv:namespace create ${{ env.KV_NAMESPACE_NAME }} 2>&1)
            KV_ID=$(echo "$CREATE_OUTPUT" | grep -oP 'id = "\K[^"]+' | head -n 1)
            echo "âœ… KV å‘½åç©ºé—´å·²åˆ›å»º: $KV_ID"
          else
            echo "âœ… KV å‘½åç©ºé—´å·²å­˜åœ¨: $KV_ID"
          fi
          
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: æ›´æ–° wrangler.toml
        run: |
          echo "æ›´æ–°é…ç½®æ–‡ä»¶..."
          
          # æ›´æ–° D1 database_id
          sed -i 's/database_id = ".*"/database_id = "${{ steps.check-d1.outputs.db_id }}"/' wrangler.toml
          
          # æ›´æ–° KV namespace id
          sed -i 's/id = ".*"/id = "${{ steps.check-kv.outputs.kv_id }}"/' wrangler.toml
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°"
          cat wrangler.toml

      - name: éƒ¨ç½² Workers
        run: |
          echo "éƒ¨ç½² Workers..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½² Pages
        run: |
          echo "éƒ¨ç½² Pages..."
          wrangler pages deploy public --project-name=${{ env.PROJECT_NAME }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: é…ç½® Pages ç»‘å®š
        run: |
          echo "é…ç½® Pages ç»‘å®š..."
          
          # è·å– Pages é¡¹ç›® ID
          PROJECT_ID=$(wrangler pages project list --json | jq -r ".[] | select(.name==\"${{ env.PROJECT_NAME }}\") | .name")
          
          if [ ! -z "$PROJECT_ID" ]; then
            echo "ä¸º Pages é¡¹ç›®é…ç½® D1 å’Œ KV ç»‘å®š..."
            echo "æ³¨æ„: Pages ç»‘å®šéœ€è¦åœ¨ Cloudflare Dashboard æ‰‹åŠ¨é…ç½®ä¸€æ¬¡"
            echo "  1. D1 binding: DB -> ${{ env.D1_DATABASE_NAME }}"
            echo "  2. KV binding: KV -> ${{ steps.check-kv.outputs.kv_id }}"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½²æ€»ç»“
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ èµ„æºä¿¡æ¯ï¼š"
          echo "  â€¢ D1 æ•°æ®åº“: ${{ steps.check-d1.outputs.db_id }}"
          echo "  â€¢ KV å‘½åç©ºé—´: ${{ steps.check-kv.outputs.kv_id }}"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
          echo "  â€¢ ä¸»é¡µ: https://${{ env.PROJECT_NAME }}.pages.dev"
          echo "  â€¢ ç®¡ç†åå°: https://${{ env.PROJECT_NAME }}.pages.dev/admin.html"
          echo ""
          echo "âš ï¸ é¦–æ¬¡éƒ¨ç½²éœ€è¦åœ¨ Cloudflare Dashboard é…ç½® Pages ç»‘å®šï¼š"
          echo "  è®¿é—®: https://dash.cloudflare.com â†’ Pages â†’ ${{ env.PROJECT_NAME }} â†’ Settings â†’ Functions"
          echo "  1. æ·»åŠ  D1 ç»‘å®š: å˜é‡å DB, æ•°æ®åº“ ${{ env.D1_DATABASE_NAME }}"
          echo "  2. æ·»åŠ  KV ç»‘å®š: å˜é‡å KV, å‘½åç©ºé—´é€‰æ‹©åŒ…å« '${{ env.KV_NAMESPACE_NAME }}' çš„"
