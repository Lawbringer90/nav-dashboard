name: Initialize Database

on:
  workflow_dispatch:
    inputs:
      reset_data:
        description: 'æ˜¯å¦é‡ç½®ä¸ºç¤ºä¾‹æ•°æ®ï¼ˆä¼šæ¸…ç©ºçŽ°æœ‰æ•°æ®ï¼ï¼‰'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  init:
    runs-on: ubuntu-latest
    name: åˆå§‹åŒ– D1 æ•°æ®åº“
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: é…ç½® wrangler.toml
        run: |
          cat > wrangler.toml <<EOF
          name = "nav-dashboard"
          main = "src/index.js"
          compatibility_date = "2024-01-01"
          
          [site]
          bucket = "./public"
          
          [[d1_databases]]
          binding = "DB"
          database_name = "nav-dashboard-db"
          database_id = "${{ secrets.D1_DATABASE_ID }}"
          
          [[kv_namespaces]]
          binding = "KV"
          id = "${{ secrets.KV_NAMESPACE_ID }}"
          EOF
          echo "âœ… wrangler.toml é…ç½®å®Œæˆ"

      - name: åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æž„
        run: |
          echo "ðŸ“¦ åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æž„..."
          wrangler d1 execute nav-dashboard-db --file=./schema.sql --remote --yes
          echo "âœ… è¡¨ç»“æž„åˆå§‹åŒ–å®Œæˆ"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: é‡ç½®ä¸ºç¤ºä¾‹æ•°æ®ï¼ˆå¯é€‰ï¼‰
        if: ${{ github.event.inputs.reset_data == 'true' }}
        run: |
          echo "âš ï¸ æ­£åœ¨é‡ç½®ä¸ºç¤ºä¾‹æ•°æ®..."
          wrangler d1 execute nav-dashboard-db --file=./reset-data.sql --remote --yes
          echo "âœ… ç¤ºä¾‹æ•°æ®å·²å¯¼å…¥"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: å®Œæˆ
        run: |
          echo "ðŸŽ‰ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "  1. è¿è¡Œ 'Deploy to Cloudflare' workflow éƒ¨ç½²åº”ç”¨"
          echo "  2. è®¿é—®ä½ çš„ Workers URL"
